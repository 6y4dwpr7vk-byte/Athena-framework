<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Diagnostic tool demo">
    <title>Demo — Athena</title>
    <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
    <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">Mode</button>
    <nav>
        <div class="container">
            <a href="../" class="site-title">Athena</a>
            <ul>
                <li><a href="../">Home</a></li>
                <li><a href="../about/">Read</a></li>
                <li><a href="../jbf/">JBF</a></li>
                <li><a href="../sociology/">Notes</a></li>
                <li><a href="../diagnostic-class/">Diagnostic</a></li>
                <li><a href="../demo/" class="active">Demo</a></li>
                <li><a href="../examples/">Examples</a></li>
                <li><a href="../info/">Citations</a></li>
            </ul>
        </div>
    </nav>

    <main class="container">
        <h1>Demo</h1>
        <p class="subtitle">Diagnostic tool</p>

        <section>
            <p>
                Applies the <a href="../jbf/">JBF</a> to input scenarios. Outputs diagnostic signals based on stated vs. observed boundary patterns.
            </p>
            <p class="boundary-note">
                Outputs are signals, not recommendations.
            </p>
        </section>

        <section>
            <h2>Diagnostic Form</h2>
            <form id="diagnosticForm">
                <div class="form-group">
                    <label for="institutionName">Institution or System Name</label>
                    <input
                        type="text"
                        id="institutionName"
                        name="institutionName"
                        placeholder="e.g., University Review Committee, Healthcare Authorization System"
                        required
                    >
                </div>

                <div class="form-group">
                    <label for="institutionType">Institution Type</label>
                    <select id="institutionType" name="institutionType" required>
                        <option value="">Select a type...</option>
                        <option value="academic">Academic Institution</option>
                        <option value="healthcare">Healthcare System</option>
                        <option value="regulatory">Regulatory/Licensing Body</option>
                        <option value="platform">Digital Platform</option>
                        <option value="government">Government Agency</option>
                        <option value="corporate">Corporate Organization</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="statedBoundaries">Stated Boundaries (Official Scope and Authority)</label>
                    <textarea
                        id="statedBoundaries"
                        name="statedBoundaries"
                        placeholder="Describe the formally documented boundaries, scope of authority, and evaluation criteria..."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="observedBehaviors">Observed Behaviors (Actual Practices)</label>
                    <textarea
                        id="observedBehaviors"
                        name="observedBehaviors"
                        placeholder="Describe the actual decision-making patterns, judgment exercises, and boundary behaviors..."
                        required
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="specificConcerns">Specific Concerns or Questions (Optional)</label>
                    <textarea
                        id="specificConcerns"
                        name="specificConcerns"
                        placeholder="Any particular boundary issues or questions about this case..."
                    ></textarea>
                </div>

                <div class="form-group">
                    <label for="imageUpload">Upload image</label>
                    <p class="text-secondary" style="font-size: 0.875rem; margin-bottom: 0.5rem;">
                        Local file. Not stored.
                    </p>
                    <input
                        type="file"
                        id="imageUpload"
                        name="imageUpload"
                        accept="image/jpeg,image/png,image/webp"
                    >
                    <div id="imagePreview" style="display: none; margin-top: 1rem;">
                        <img id="previewImg" src="" alt="Preview" style="max-width: 200px; border-radius: 4px;">
                        <div style="margin-top: 0.5rem;">
                            <button type="button" id="replaceBtn" style="font-size: 0.875rem; padding: 0.5rem 1rem;">Replace</button>
                            <button type="button" id="removeBtn" style="font-size: 0.875rem; padding: 0.5rem 1rem; background: transparent; color: var(--text-secondary); border: 1px solid var(--border);">Remove</button>
                        </div>
                    </div>
                    <div id="uploadError" style="display: none; color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem;"></div>
                </div>

                <button type="submit" id="submitBtn">Run diagnostic</button>
            </form>
        </section>

        <section id="resultsSection" style="display: none;">
            <h2>Diagnostic Results</h2>
            <div style="margin-bottom: 1rem;">
                <button id="downloadPdfBtn" style="display: none; font-size: 0.875rem; padding: 0.5rem 1rem;">Download PDF</button>
                <div id="pdfError" style="display: none; color: #dc2626; font-size: 0.875rem; margin-top: 0.5rem;"></div>
            </div>
            <div id="diagnosticOutput" class="diagnostic-output">
                <div id="loadingIndicator" style="display: none;">
                    <p>Running diagnostic...</p>
                </div>
                <div id="resultsContent"></div>
            </div>
        </section>

        <section>
            <h3>Input</h3>
            <ul>
                <li><strong>Stated Boundaries:</strong> Official policies, documented criteria, formal scope</li>
                <li><strong>Observed Behaviors:</strong> Actual practices, decision patterns, specific cases</li>
            </ul>

            <h3>Output</h3>
            <ul>
                <li>Classification signal (A, B, or C)</li>
                <li>Discrepancy indicators between stated and observed boundaries</li>
                <li>Missing or unclear data points</li>
            </ul>
            <p class="boundary-note">
                Outputs are diagnostic signals. Interpretation remains external.
            </p>
        </section>

        <section>
            <h3>Related</h3>
            <ul>
                <li><a href="../jbf/">JBF</a></li>
                <li><a href="../diagnostic-class/">Diagnostic</a></li>
                <li><a href="../examples/">Examples</a></li>
            </ul>
        </section>
    </main>

    <footer>
        <p>Athena</p>
        <p class="text-secondary">Diagnostic boundary framework</p>
    </footer>

    <script>
        // Theme toggle
        const themeToggle = document.getElementById('theme-toggle');
        const root = document.documentElement;
        const currentTheme = localStorage.getItem('theme') || 'dark';
        root.setAttribute('data-theme', currentTheme);
        themeToggle.addEventListener('click', () => {
            const theme = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            root.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        });

        // Image upload handling
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const previewImg = document.getElementById('previewImg');
        const replaceBtn = document.getElementById('replaceBtn');
        const removeBtn = document.getElementById('removeBtn');
        const uploadError = document.getElementById('uploadError');

        const maxFileSize = 5 * 1024 * 1024; // 5MB
        let uploadedFile = null;

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            uploadError.style.display = 'none';

            // Validate file type
            if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) {
                uploadError.textContent = 'Unsupported file type.';
                uploadError.style.display = 'block';
                imageUpload.value = '';
                return;
            }

            // Validate file size
            if (file.size > maxFileSize) {
                uploadError.textContent = 'File exceeds size limit.';
                uploadError.style.display = 'block';
                imageUpload.value = '';
                return;
            }

            // Show preview
            uploadedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        replaceBtn.addEventListener('click', () => {
            imageUpload.click();
        });

        removeBtn.addEventListener('click', () => {
            imageUpload.value = '';
            uploadedFile = null;
            imagePreview.style.display = 'none';
            uploadError.style.display = 'none';
        });

        // Form submission
        const diagnosticForm = document.getElementById('diagnosticForm');
        const resultsSection = document.getElementById('resultsSection');
        const diagnosticOutput = document.getElementById('diagnosticOutput');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const resultsContent = document.getElementById('resultsContent');
        const submitBtn = document.getElementById('submitBtn');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        const pdfError = document.getElementById('pdfError');

        let latestResults = null;

        diagnosticForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Show loading state
            resultsSection.style.display = 'block';
            loadingIndicator.style.display = 'block';
            resultsContent.innerHTML = '';
            diagnosticOutput.classList.add('loading');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing...';

            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Collect form data
            const formData = new FormData(diagnosticForm);

            try {
                // Send POST request to Cloudflare Worker
                const response = await fetch('http://localhost:8787', {
                    method: 'POST',
                    body: formData,
                    // Note: multipart/form-data Content-Type is automatically set by browser
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                // Store results for PDF generation
                latestResults = {
                    timestamp: new Date().toISOString(),
                    inputs: {
                        institutionName: formData.get('institutionName'),
                        institutionType: formData.get('institutionType'),
                        statedBoundaries: formData.get('statedBoundaries'),
                        observedBehaviors: formData.get('observedBehaviors'),
                        specificConcerns: formData.get('specificConcerns'),
                        imageFilename: uploadedFile ? uploadedFile.name : null
                    },
                    output: data.diagnostic
                };

                // Display results
                loadingIndicator.style.display = 'none';
                diagnosticOutput.classList.remove('loading');
                downloadPdfBtn.style.display = 'inline-block';

                if (data.diagnostic) {
                    resultsContent.innerHTML = `
                        <h3>Output</h3>
                        <div class="card">
                            ${data.diagnostic}
                        </div>
                    `;
                } else {
                    resultsContent.innerHTML = `
                        <div class="error">
                            Unexpected response format from server.
                        </div>
                    `;
                }

            } catch (error) {
                // Handle errors
                loadingIndicator.style.display = 'none';
                diagnosticOutput.classList.remove('loading');

                resultsContent.innerHTML = `
                    <div class="error">
                        ${error.message}
                    </div>
                `;

                console.error('Diagnostic tool error:', error);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                submitBtn.textContent = 'Run diagnostic';
            }
        });

        // PDF Download
        downloadPdfBtn.addEventListener('click', async () => {
            if (!latestResults) {
                pdfError.textContent = 'No results available.';
                pdfError.style.display = 'block';
                return;
            }

            pdfError.style.display = 'none';
            downloadPdfBtn.disabled = true;
            downloadPdfBtn.textContent = 'Generating...';

            try {
                // Simple PDF generation using browser print to PDF
                // Create a temporary element with the content
                const pdfContent = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Athena — Demo Output</title>
                        <style>
                            body { font-family: sans-serif; max-width: 800px; margin: 40px; line-height: 1.6; }
                            h1 { font-size: 24px; margin-bottom: 10px; }
                            h2 { font-size: 18px; margin-top: 20px; margin-bottom: 10px; }
                            .meta { color: #666; font-size: 14px; margin-bottom: 20px; }
                            .section { margin-bottom: 20px; }
                            .label { font-weight: bold; }
                            .footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #ccc; font-size: 12px; color: #666; }
                        </style>
                    </head>
                    <body>
                        <h1>Athena — Demo Output</h1>
                        <div class="meta">Generated: ${new Date(latestResults.timestamp).toLocaleString()}</div>

                        <h2>Input Summary</h2>
                        <div class="section">
                            <div><span class="label">Institution:</span> ${latestResults.inputs.institutionName || 'Not provided'}</div>
                            <div><span class="label">Type:</span> ${latestResults.inputs.institutionType || 'Not provided'}</div>
                            ${latestResults.inputs.imageFilename ? `<div><span class="label">Image:</span> ${latestResults.inputs.imageFilename}</div>` : ''}
                        </div>

                        <div class="section">
                            <div class="label">Stated Boundaries:</div>
                            <div>${latestResults.inputs.statedBoundaries || 'Not provided'}</div>
                        </div>

                        <div class="section">
                            <div class="label">Observed Behaviors:</div>
                            <div>${latestResults.inputs.observedBehaviors || 'Not provided'}</div>
                        </div>

                        ${latestResults.inputs.specificConcerns ? `
                        <div class="section">
                            <div class="label">Specific Concerns:</div>
                            <div>${latestResults.inputs.specificConcerns}</div>
                        </div>
                        ` : ''}

                        <h2>Output</h2>
                        <div class="section">
                            ${latestResults.output}
                        </div>

                        <div class="footer">
                            Outputs are diagnostic signals. Interpretation remains external.<br>
                            No recommendations are produced.
                        </div>
                    </body>
                    </html>
                `;

                // Open print dialog
                const printWindow = window.open('', '_blank');
                printWindow.document.write(pdfContent);
                printWindow.document.close();
                printWindow.focus();
                printWindow.print();

            } catch (error) {
                pdfError.textContent = 'PDF could not be generated.';
                pdfError.style.display = 'block';
                console.error('PDF generation error:', error);
            } finally {
                downloadPdfBtn.disabled = false;
                downloadPdfBtn.textContent = 'Download PDF';
            }
        });
    </script>
</body>
</html>
